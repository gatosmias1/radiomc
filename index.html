<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadioMC - Sua R√°dio Musical</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), 0 0 40px rgba(0, 255, 255, 0.05);
        }
        
        .drop-zone {
            border: 3px dashed rgba(0, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }
        
        .music-item {
            transition: all 0.2s ease;
        }
        
        .music-item:hover {
            background: rgba(0, 255, 255, 0.15);
        }
        
        .music-item.playing {
            background: rgba(0, 255, 255, 0.25);
            border-left: 4px solid #00ffff;
        }
        
        .tab-btn {
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #00d9ff, #a855f7);
            color: white;
        }
        
        .radio-card {
            transition: all 0.3s ease;
        }
        
        .radio-card:hover {
            transform: translateY(-3px);
            background: rgba(0, 255, 255, 0.15);
        }
        
        .radio-card.playing {
            background: rgba(0, 255, 255, 0.25);
            border: 2px solid #00ffff;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 6px;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #00ffff, #ff00ff);
            border-radius: 50%;
            cursor: pointer;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning { animation: spin 3s linear infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulsing { animation: pulse 1.5s ease-in-out infinite; }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(0,255,255,0.4); border-radius: 3px; }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .toast.success { background: linear-gradient(135deg, #00b894, #00cec9); }
        .toast.error { background: linear-gradient(135deg, #d63031, #e17055); }
        .toast.info { background: linear-gradient(135deg, #0984e3, #74b9ff); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .play-btn-main {
            background: linear-gradient(135deg, #00d9ff, #a855f7);
            transition: all 0.3s ease;
        }
        
        .play-btn-main:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
        }

        .equalizer {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }

        .equalizer span {
            width: 3px;
            background: linear-gradient(to top, #00ffff, #a855f7);
            border-radius: 2px;
            animation: equalize 0.5s ease-in-out infinite alternate;
        }

        .equalizer span:nth-child(1) { animation-delay: 0s; }
        .equalizer span:nth-child(2) { animation-delay: 0.1s; }
        .equalizer span:nth-child(3) { animation-delay: 0.2s; }
        .equalizer span:nth-child(4) { animation-delay: 0.3s; }

        @keyframes equalize {
            0% { height: 4px; }
            100% { height: 16px; }
        }

        .genre-btn {
            transition: all 0.2s ease;
        }
        
        .genre-btn:hover, .genre-btn.active {
            background: linear-gradient(135deg, #00d9ff, #a855f7);
            transform: scale(1.05);
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: #ff0000;
            border-radius: 50%;
            animation: pulse 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="text-white p-3 md:p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-5xl font-bold bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                <i class="fas fa-broadcast-tower mr-2"></i>RadioMC
            </h1>
            <p class="text-gray-400 mt-1 text-sm">Sua biblioteca musical + R√°dios do mundo</p>
        </header>

        <!-- Tabs -->
        <div class="flex justify-center gap-2 mb-4">
            <button onclick="switchTab('library')" id="tabLibrary" class="tab-btn active px-6 py-2 rounded-full font-medium glass">
                <i class="fas fa-music mr-2"></i>Biblioteca
            </button>
            <button onclick="switchTab('radios')" id="tabRadios" class="tab-btn px-6 py-2 rounded-full font-medium glass">
                <i class="fas fa-broadcast-tower mr-2"></i>R√°dios Online
            </button>
        </div>

        <!-- Container Principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            
            <!-- Conte√∫do da Aba (Esquerda) -->
            <div class="lg:col-span-2 space-y-4">
                
                <!-- ABA BIBLIOTECA -->
                <div id="libraryTab">
                    <!-- Upload -->
                    <div class="glass rounded-2xl p-4 neon-glow mb-4">
                        <h2 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-2 text-cyan-400"></i>
                            Adicionar M√∫sicas
                        </h2>
                        <div id="dropZone" class="drop-zone rounded-xl p-6 text-center cursor-pointer">
                            <i class="fas fa-music text-4xl text-cyan-400 mb-2"></i>
                            <p class="text-base">Arraste m√∫sicas aqui</p>
                            <p class="text-gray-400 text-sm">ou clique para selecionar</p>
                            <input type="file" id="fileInput" multiple accept="audio/*" class="hidden">
                        </div>
                        <div id="uploadProgress" class="hidden mt-3">
                            <div class="flex items-center gap-3">
                                <div class="loading-spinner"></div>
                                <span id="uploadText" class="text-sm">Processando...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Biblioteca -->
                    <div class="glass rounded-2xl p-4 neon-glow">
                        <div class="flex flex-wrap justify-between items-center gap-2 mb-3">
                            <h2 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-compact-disc mr-2 text-purple-400"></i>
                                Minhas M√∫sicas
                                <span id="musicCount" class="ml-2 text-xs bg-purple-500/80 px-2 py-0.5 rounded-full">0</span>
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="playAllLocal()" class="bg-cyan-500 hover:bg-cyan-400 px-3 py-1.5 rounded-lg text-xs font-medium transition">
                                    <i class="fas fa-play mr-1"></i>Tocar
                                </button>
                                <button onclick="shufflePlayLocal()" class="bg-purple-500 hover:bg-purple-400 px-3 py-1.5 rounded-lg text-xs font-medium transition">
                                    <i class="fas fa-random mr-1"></i>Aleat√≥rio
                                </button>
                                <button onclick="clearLibrary()" class="bg-red-500/80 hover:bg-red-500 px-3 py-1.5 rounded-lg text-xs font-medium transition">
                                    <i class="fas fa-trash mr-1"></i>Limpar
                                </button>
                            </div>
                        </div>
                        <div id="musicLibrary" class="space-y-1.5 max-h-80 overflow-y-auto scrollbar-thin pr-1">
                            <p class="text-gray-400 text-center py-8">
                                <i class="fas fa-folder-open text-3xl mb-2 block opacity-50"></i>
                                Nenhuma m√∫sica adicionada
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ABA R√ÅDIOS ONLINE -->
                <div id="radiosTab" class="hidden">
                    <!-- Busca e Filtros -->
                    <div class="glass rounded-2xl p-4 neon-glow mb-4">
                        <div class="flex flex-col md:flex-row gap-3 mb-4">
                            <div class="flex-1 relative">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="radioSearch" placeholder="Buscar r√°dio..." 
                                    class="w-full bg-white/10 border border-white/20 rounded-xl pl-10 pr-4 py-2.5 focus:outline-none focus:border-cyan-400">
                            </div>
                            <select id="countryFilter" class="bg-white/10 border border-white/20 rounded-xl px-4 py-2.5 focus:outline-none focus:border-cyan-400">
                                <option value="">üåç Todos os pa√≠ses</option>
                                <option value="BR">üáßüá∑ Brasil</option>
                                <option value="US">üá∫üá∏ EUA</option>
                                <option value="GB">üá¨üáß Reino Unido</option>
                                <option value="JP">üáØüáµ Jap√£o</option>
                                <option value="DE">üá©üá™ Alemanha</option>
                                <option value="FR">üá´üá∑ Fran√ßa</option>
                                <option value="ES">üá™üá∏ Espanha</option>
                                <option value="PT">üáµüáπ Portugal</option>
                            </select>
                        </div>
                        
                        <!-- G√™neros -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterGenre('')" class="genre-btn active px-3 py-1 rounded-full text-xs glass" data-genre="">Todos</button>
                            <button onclick="filterGenre('pop')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="pop">Pop</button>
                            <button onclick="filterGenre('rock')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="rock">Rock</button>
                            <button onclick="filterGenre('hip hop')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="hip hop">Hip-Hop</button>
                            <button onclick="filterGenre('electronic')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="electronic">Eletr√¥nica</button>
                            <button onclick="filterGenre('jazz')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="jazz">Jazz</button>
                            <button onclick="filterGenre('classical')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="classical">Cl√°ssica</button>
                            <button onclick="filterGenre('country')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="country">Country</button>
                            <button onclick="filterGenre('reggae')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="reggae">Reggae</button>
                            <button onclick="filterGenre('latin')" class="genre-btn px-3 py-1 rounded-full text-xs glass" data-genre="latin">Latino</button>
                        </div>
                    </div>

                    <!-- Lista de R√°dios -->
                    <div class="glass rounded-2xl p-4 neon-glow">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-semibold flex items-center">
                                <i class="fas fa-broadcast-tower mr-2 text-cyan-400"></i>
                                R√°dios Dispon√≠veis
                                <span id="radioCount" class="ml-2 text-xs bg-cyan-500/80 px-2 py-0.5 rounded-full">0</span>
                            </h2>
                            <div id="radioLoading" class="hidden">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                        <div id="radioList" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-96 overflow-y-auto scrollbar-thin pr-1">
                            <p class="text-gray-400 text-center py-8 col-span-2">
                                <i class="fas fa-broadcast-tower text-3xl mb-2 block opacity-50"></i>
                                Carregando r√°dios...
                            </p>
                        </div>
                    </div>

                    <!-- Favoritos -->
                    <div class="glass rounded-2xl p-4 neon-glow mt-4">
                        <h2 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fas fa-star mr-2 text-yellow-400"></i>
                            R√°dios Favoritas
                            <span id="favCount" class="ml-2 text-xs bg-yellow-500/80 px-2 py-0.5 rounded-full">0</span>
                        </h2>
                        <div id="favoriteRadios" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-48 overflow-y-auto scrollbar-thin pr-1">
                            <p class="text-gray-500 text-center py-4 col-span-2 text-sm">
                                Nenhuma r√°dio favorita ainda
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player (Direita) -->
            <div class="space-y-4">
                <!-- Player Principal -->
                <div class="glass rounded-2xl p-4 neon-glow">
                    <div class="text-center mb-4">
                        <div id="albumArt" class="w-32 h-32 mx-auto bg-gradient-to-br from-cyan-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mb-3 shadow-2xl">
                            <i class="fas fa-music text-4xl opacity-80"></i>
                        </div>
                        <div class="flex items-center justify-center gap-2 mb-1">
                            <div id="liveIndicator" class="live-indicator hidden"></div>
                            <span id="liveText" class="text-xs text-red-400 hidden">AO VIVO</span>
                        </div>
                        <h3 id="currentTitle" class="text-base font-semibold truncate px-2">Nenhuma m√∫sica</h3>
                        <p id="currentArtist" class="text-gray-400 text-xs truncate">Selecione uma m√∫sica ou r√°dio</p>
                    </div>

                    <!-- Progresso (s√≥ para m√∫sicas locais) -->
                    <div id="progressContainer" class="mb-4">
                        <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1" class="w-full">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="flex justify-center items-center gap-3 mb-4">
                        <button id="shuffleBtn" onclick="toggleShuffle()" class="control-btn text-xl p-2 hover:text-cyan-400 transition" title="Aleat√≥rio">
                            <i class="fas fa-random"></i>
                        </button>
                        <button onclick="prevTrack()" class="control-btn text-xl p-2 hover:text-cyan-400 transition" title="Anterior">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button id="playPauseBtn" onclick="togglePlay()" class="play-btn-main w-14 h-14 rounded-full flex items-center justify-center text-2xl">
                            <i class="fas fa-play ml-1"></i>
                        </button>
                        <button onclick="nextTrack()" class="control-btn text-xl p-2 hover:text-cyan-400 transition" title="Pr√≥xima">
                            <i class="fas fa-step-forward"></i>
                        </button>
                        <button id="repeatBtn" onclick="toggleRepeat()" class="control-btn text-xl p-2 hover:text-cyan-400 transition" title="Repetir">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>

                    <!-- Volume -->
                    <div class="flex items-center gap-3">
                        <button onclick="toggleMute()" class="text-gray-400 hover:text-white transition">
                            <i id="volumeIcon" class="fas fa-volume-up"></i>
                        </button>
                        <input type="range" id="volumeBar" value="80" min="0" max="100" class="flex-1">
                        <span id="volumePercent" class="text-xs text-gray-400 w-8">80%</span>
                    </div>
                </div>

                <!-- Op√ß√µes -->
                <div class="glass rounded-2xl p-4 neon-glow">
                    <h2 class="text-base font-semibold mb-3 flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-cyan-400"></i>
                        Op√ß√µes
                    </h2>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center justify-between cursor-pointer p-2 rounded-lg hover:bg-white/5">
                            <span><i class="fas fa-redo-alt mr-2 text-purple-400"></i>Repetir M√∫sica</span>
                            <input type="checkbox" id="repeatOne" class="w-4 h-4 accent-cyan-500">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer p-2 rounded-lg hover:bg-white/5">
                            <span><i class="fas fa-sync mr-2 text-cyan-400"></i>Repetir Playlist</span>
                            <input type="checkbox" id="repeatPlaylist" checked class="w-4 h-4 accent-cyan-500">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer p-2 rounded-lg hover:bg-white/5">
                            <span><i class="fas fa-random mr-2 text-pink-400"></i>Modo Aleat√≥rio</span>
                            <input type="checkbox" id="shuffleMode" class="w-4 h-4 accent-cyan-500">
                        </label>
                    </div>
                </div>

                <!-- Info da R√°dio Atual -->
                <div id="radioInfo" class="glass rounded-2xl p-4 neon-glow hidden">
                    <h2 class="text-base font-semibold mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-cyan-400"></i>
                        Sobre a R√°dio
                    </h2>
                    <div class="text-sm space-y-2">
                        <p><span class="text-gray-400">Pa√≠s:</span> <span id="radioCountry">-</span></p>
                        <p><span class="text-gray-400">G√™nero:</span> <span id="radioGenre">-</span></p>
                        <p><span class="text-gray-400">Bitrate:</span> <span id="radioBitrate">-</span></p>
                        <a id="radioWebsite" href="#" target="_blank" class="text-cyan-400 hover:underline block mt-2">
                            <i class="fas fa-external-link-alt mr-1"></i>Visitar site
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualizador -->
        <div class="glass rounded-2xl p-3 mt-4 neon-glow">
            <div id="visualizer" class="flex justify-center items-end h-10 gap-0.5"></div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-4 text-gray-500 text-xs">
            <p>üéµ RadioMC - M√∫sicas locais + R√°dios do mundo todo</p>
        </footer>
    </div>

    <audio id="audioPlayer" preload="auto" crossorigin="anonymous"></audio>

    <script>
        // =============================================
        // CONFIGURA√á√ïES
        // =============================================
        const RADIO_API = 'https://de1.api.radio-browser.info/json';
        const DB_NAME = 'RadioMC_DB_v4';
        const DB_VERSION = 1;
        const STORE_NAME = 'musicFiles';
        
        // =============================================
        // ESTADO GLOBAL
        // =============================================
        let db = null;
        let musicLibrary = [];
        let radioStations = [];
        let favoriteRadios = [];
        let currentIndex = -1;
        let currentRadio = null;
        let isPlaying = false;
        let isShuffled = false;
        let repeatMode = 'all';
        let currentBlobUrl = null;
        let lastVolume = 80;
        let currentTab = 'library';
        let currentGenre = '';
        let searchTimeout = null;

        const audio = document.getElementById('audioPlayer');

        // =============================================
        // INICIALIZA√á√ÉO
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                await loadLibrary();
                loadFavorites();
                setupEvents();
                createVisualizer();
                loadSettings();
                updateVolume();
                loadRadios();
                showToast('üéµ RadioMC pronto!', 'success');
            } catch (error) {
                console.error('Erro ao iniciar:', error);
                showToast('Erro ao iniciar', 'error');
            }
        });

        // =============================================
        // INDEXEDDB
        // =============================================
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function saveMusic(name, arrayBuffer, mimeType) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const req = store.add({ name, buffer: arrayBuffer, mimeType: mimeType || 'audio/mpeg', size: arrayBuffer.byteLength, date: Date.now() });
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function loadAllMusic() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => reject(req.error);
            });
        }

        async function deleteMusic(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const req = store.delete(id);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }

        async function clearAllMusic() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const req = store.clear();
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }

        async function loadLibrary() {
            const data = await loadAllMusic();
            musicLibrary = data.map(item => ({
                id: item.id, name: item.name, buffer: item.buffer,
                mimeType: item.mimeType, size: item.size
            }));
            renderLibrary();
        }

        // =============================================
        // EVENTOS
        // =============================================
        function setupEvents() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.onclick = () => fileInput.click();
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
            dropZone.ondragleave = () => dropZone.classList.remove('dragover');
            dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
            fileInput.onchange = (e) => { handleFiles(e.target.files); fileInput.value = ''; };

            audio.onloadedmetadata = () => {
                if (currentRadio) return;
                document.getElementById('duration').textContent = formatTime(audio.duration);
            };
            
            audio.ontimeupdate = () => {
                if (currentRadio) return;
                if (audio.duration && isFinite(audio.duration)) {
                    document.getElementById('progressBar').value = (audio.currentTime / audio.duration) * 100;
                    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
                }
            };
            
            audio.onended = handleTrackEnd;
            audio.onplay = () => { isPlaying = true; updatePlayBtn(); startVisualizer(); document.getElementById('albumArt').classList.add('spinning'); };
            audio.onpause = () => { isPlaying = false; updatePlayBtn(); stopVisualizer(); document.getElementById('albumArt').classList.remove('spinning'); };

            document.getElementById('progressBar').oninput = (e) => {
                if (currentRadio) return;
                if (audio.duration && isFinite(audio.duration)) {
                    audio.currentTime = (e.target.value / 100) * audio.duration;
                }
            };
            
            document.getElementById('volumeBar').oninput = updateVolume;

            document.getElementById('repeatOne').onchange = (e) => {
                repeatMode = e.target.checked ? 'one' : (document.getElementById('repeatPlaylist').checked ? 'all' : 'none');
                if (e.target.checked) document.getElementById('repeatPlaylist').checked = false;
                updateRepeatBtn(); saveSettings();
            };

            document.getElementById('repeatPlaylist').onchange = (e) => {
                repeatMode = e.target.checked ? 'all' : (document.getElementById('repeatOne').checked ? 'one' : 'none');
                if (e.target.checked) document.getElementById('repeatOne').checked = false;
                updateRepeatBtn(); saveSettings();
            };

            document.getElementById('shuffleMode').onchange = (e) => {
                isShuffled = e.target.checked;
                updateShuffleBtn(); saveSettings();
            };

            // Busca de r√°dios
            document.getElementById('radioSearch').oninput = (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => searchRadios(e.target.value), 500);
            };

            document.getElementById('countryFilter').onchange = (e) => {
                loadRadios(e.target.value, currentGenre);
            };

            // Teclado
            document.onkeydown = (e) => {
                if (e.target.tagName === 'INPUT') return;
                if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
                else if (e.code === 'ArrowRight') nextTrack();
                else if (e.code === 'ArrowLeft') prevTrack();
            };
        }

        // =============================================
        // TABS
        // =============================================
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('libraryTab').classList.toggle('hidden', tab !== 'library');
            document.getElementById('radiosTab').classList.toggle('hidden', tab !== 'radios');
            document.getElementById('tabLibrary').classList.toggle('active', tab === 'library');
            document.getElementById('tabRadios').classList.toggle('active', tab === 'radios');
            document.getElementById('progressContainer').classList.toggle('hidden', tab === 'radios' && currentRadio);
        }

        // =============================================
        // UPLOAD DE M√öSICAS
        // =============================================
        async function handleFiles(files) {
            const validFiles = Array.from(files).filter(f => f.type.startsWith('audio/') || /\.(mp3|wav|ogg|m4a|flac)$/i.test(f.name));
            if (validFiles.length === 0) { showToast('Nenhum arquivo de √°udio v√°lido', 'error'); return; }

            const progress = document.getElementById('uploadProgress');
            const text = document.getElementById('uploadText');
            progress.classList.remove('hidden');

            let count = 0;
            for (const file of validFiles) {
                text.textContent = `Processando: ${file.name.substring(0, 20)}...`;
                try {
                    const buffer = await file.arrayBuffer();
                    const name = file.name.replace(/\.[^/.]+$/, '');
                    const id = await saveMusic(name, buffer, file.type);
                    musicLibrary.push({ id, name, buffer, mimeType: file.type, size: buffer.byteLength });
                    count++;
                } catch (err) { console.error('Erro:', err); }
            }

            progress.classList.add('hidden');
            renderLibrary();
            if (count > 0) showToast(`‚úÖ ${count} m√∫sica(s) adicionada(s)!`, 'success');
        }

        // =============================================
        // RENDERIZA√á√ÉO BIBLIOTECA
        // =============================================
        function renderLibrary() {
            const container = document.getElementById('musicLibrary');
            document.getElementById('musicCount').textContent = musicLibrary.length;

            if (musicLibrary.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8"><i class="fas fa-folder-open text-3xl mb-2 block opacity-50"></i>Nenhuma m√∫sica adicionada</p>';
                return;
            }

            container.innerHTML = musicLibrary.map((m, i) => `
                <div class="music-item flex items-center gap-2 p-2.5 rounded-lg cursor-pointer ${currentIndex === i && !currentRadio ? 'playing' : ''}" onclick="playLocalTrack(${i})">
                    <div class="w-9 h-9 bg-gradient-to-br from-cyan-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        ${currentIndex === i && isPlaying && !currentRadio ? '<div class="equalizer"><span></span><span></span><span></span><span></span></div>' : '<i class="fas fa-music text-xs"></i>'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="truncate text-sm font-medium">${escapeHtml(m.name)}</p>
                        <p class="text-xs text-gray-500">${formatSize(m.size)}</p>
                    </div>
                    <button onclick="event.stopPropagation(); removeTrack(${i})" class="text-gray-500 hover:text-red-400 p-1">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        // =============================================
        // R√ÅDIOS ONLINE
        // =============================================
        async function loadRadios(country = '', genre = '') {
            const loading = document.getElementById('radioLoading');
            loading.classList.remove('hidden');

            try {
                let url = `${RADIO_API}/stations/search?limit=50&order=clickcount&reverse=true&hidebroken=true`;
                if (country) url += `&countrycode=${country}`;
                if (genre) url += `&tag=${encodeURIComponent(genre)}`;

                const response = await fetch(url);
                radioStations = await response.json();
                renderRadios();
            } catch (error) {
                console.error('Erro ao carregar r√°dios:', error);
                showToast('Erro ao carregar r√°dios', 'error');
            }

            loading.classList.add('hidden');
        }

        async function searchRadios(query) {
            if (!query.trim()) { loadRadios(); return; }

            const loading = document.getElementById('radioLoading');
            loading.classList.remove('hidden');

            try {
                const url = `${RADIO_API}/stations/search?name=${encodeURIComponent(query)}&limit=50&order=clickcount&reverse=true&hidebroken=true`;
                const response = await fetch(url);
                radioStations = await response.json();
                renderRadios();
            } catch (error) {
                console.error('Erro na busca:', error);
            }

            loading.classList.add('hidden');
        }

        function filterGenre(genre) {
            currentGenre = genre;
            document.querySelectorAll('.genre-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.genre === genre);
            });
            loadRadios(document.getElementById('countryFilter').value, genre);
        }

        function renderRadios() {
            const container = document.getElementById('radioList');
            document.getElementById('radioCount').textContent = radioStations.length;

            if (radioStations.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8 col-span-2"><i class="fas fa-broadcast-tower text-3xl mb-2 block opacity-50"></i>Nenhuma r√°dio encontrada</p>';
                return;
            }

            container.innerHTML = radioStations.map((r, i) => `
                <div class="radio-card glass rounded-xl p-3 cursor-pointer ${currentRadio?.stationuuid === r.stationuuid ? 'playing' : ''}" onclick="playRadio(${i})">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-purple-600 flex items-center justify-center flex-shrink-0 overflow-hidden">
                            ${r.favicon ? `<img src="${r.favicon}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><i class="fas fa-broadcast-tower hidden"></i>` : '<i class="fas fa-broadcast-tower"></i>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm truncate">${escapeHtml(r.name)}</p>
                            <p class="text-xs text-gray-400 truncate">${r.country || 'Desconhecido'} ${r.tags ? '‚Ä¢ ' + r.tags.split(',')[0] : ''}</p>
                        </div>
                        <button onclick="event.stopPropagation(); toggleFavorite('${r.stationuuid}')" class="p-2 hover:scale-110 transition">
                            <i class="fas fa-star ${isFavorite(r.stationuuid) ? 'text-yellow-400' : 'text-gray-500'}"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function playRadio(index) {
            const radio = radioStations[index];
            if (!radio || !radio.url_resolved) {
                showToast('R√°dio indispon√≠vel', 'error');
                return;
            }

            currentRadio = radio;
            currentIndex = -1;

            if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }

            audio.src = radio.url_resolved;
            audio.play().then(() => {
                updateNowPlaying(radio.name, radio.country || 'R√°dio Online');
                showLiveIndicator(true);
                updateRadioInfo(radio);
                renderRadios();
                renderFavorites();
            }).catch(err => {
                console.error('Erro ao tocar r√°dio:', err);
                showToast('Erro ao conectar na r√°dio', 'error');
            });

            document.getElementById('progressContainer').classList.add('hidden');
        }

        function updateRadioInfo(radio) {
            document.getElementById('radioInfo').classList.remove('hidden');
            document.getElementById('radioCountry').textContent = radio.country || '-';
            document.getElementById('radioGenre').textContent = radio.tags?.split(',').slice(0, 3).join(', ') || '-';
            document.getElementById('radioBitrate').textContent = radio.bitrate ? radio.bitrate + ' kbps' : '-';
            const website = document.getElementById('radioWebsite');
            if (radio.homepage) { website.href = radio.homepage; website.classList.remove('hidden'); }
            else { website.classList.add('hidden'); }
        }

        // =============================================
        // FAVORITOS
        // =============================================
        function loadFavorites() {
            try {
                favoriteRadios = JSON.parse(localStorage.getItem('radiomc_favorites') || '[]');
                renderFavorites();
            } catch (e) { favoriteRadios = []; }
        }

        function saveFavorites() {
            localStorage.setItem('radiomc_favorites', JSON.stringify(favoriteRadios));
        }

        function isFavorite(uuid) {
            return favoriteRadios.some(r => r.stationuuid === uuid);
        }

        function toggleFavorite(uuid) {
            const radio = radioStations.find(r => r.stationuuid === uuid) || favoriteRadios.find(r => r.stationuuid === uuid);
            if (!radio) return;

            const index = favoriteRadios.findIndex(r => r.stationuuid === uuid);
            if (index >= 0) {
                favoriteRadios.splice(index, 1);
                showToast('Removido dos favoritos', 'info');
            } else {
                favoriteRadios.push(radio);
                showToast('‚≠ê Adicionado aos favoritos!', 'success');
            }

            saveFavorites();
            renderRadios();
            renderFavorites();
        }

        function renderFavorites() {
            const container = document.getElementById('favoriteRadios');
            document.getElementById('favCount').textContent = favoriteRadios.length;

            if (favoriteRadios.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-2 text-sm">Nenhuma r√°dio favorita ainda</p>';
                return;
            }

            container.innerHTML = favoriteRadios.map((r, i) => `
                <div class="radio-card glass rounded-xl p-2 cursor-pointer ${currentRadio?.stationuuid === r.stationuuid ? 'playing' : ''}" onclick="playFavoriteRadio(${i})">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-star text-xs"></i>
                        </div>
                        <p class="font-medium text-xs truncate flex-1">${escapeHtml(r.name)}</p>
                        <button onclick="event.stopPropagation(); toggleFavorite('${r.stationuuid}')" class="text-red-400 hover:text-red-300 p-1">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function playFavoriteRadio(index) {
            const radio = favoriteRadios[index];
            if (!radio) return;
            radioStations = [radio];
            playRadio(0);
        }

        // =============================================
        // REPRODU√á√ÉO LOCAL
        // =============================================
        function createBlobUrl(music) {
            if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
            try {
                let arrayBuffer = music.buffer;
                if (arrayBuffer && arrayBuffer.buffer) arrayBuffer = arrayBuffer.buffer;
                const blob = new Blob([arrayBuffer], { type: music.mimeType || 'audio/mpeg' });
                currentBlobUrl = URL.createObjectURL(blob);
                return currentBlobUrl;
            } catch (err) { console.error('Erro ao criar blob:', err); return null; }
        }

        function playLocalTrack(index) {
            if (index < 0 || index >= musicLibrary.length) return;
            
            const music = musicLibrary[index];
            if (!music || !music.buffer) { showToast('M√∫sica corrompida', 'error'); return; }
            
            currentIndex = index;
            currentRadio = null;

            const url = createBlobUrl(music);
            if (!url) { showToast('Erro ao carregar', 'error'); return; }
            
            audio.src = url;
            audio.play().then(() => {
                updateNowPlaying(music.name, 'Reproduzindo');
                showLiveIndicator(false);
                document.getElementById('progressContainer').classList.remove('hidden');
                document.getElementById('radioInfo').classList.add('hidden');
                renderLibrary();
            }).catch(err => {
                updateNowPlaying(music.name, 'Clique ‚ñ∂ para tocar');
                renderLibrary();
            });
        }

        function playAllLocal() {
            if (musicLibrary.length > 0) { isShuffled = false; updateShuffleBtn(); playLocalTrack(0); }
            else showToast('Adicione m√∫sicas primeiro!', 'info');
        }

        function shufflePlayLocal() {
            if (musicLibrary.length > 0) {
                isShuffled = true;
                document.getElementById('shuffleMode').checked = true;
                updateShuffleBtn();
                playLocalTrack(Math.floor(Math.random() * musicLibrary.length));
            } else showToast('Adicione m√∫sicas primeiro!', 'info');
        }

        // =============================================
        // CONTROLES
        // =============================================
        function togglePlay() {
            if (currentRadio) {
                if (isPlaying) audio.pause();
                else audio.play().catch(() => showToast('Erro ao reproduzir', 'error'));
                return;
            }

            if (musicLibrary.length === 0) { showToast('Adicione m√∫sicas primeiro!', 'info'); return; }
            if (currentIndex === -1) { playLocalTrack(0); return; }

            if (isPlaying) audio.pause();
            else audio.play().catch(() => playLocalTrack(currentIndex));
        }

        function prevTrack() {
            if (currentRadio || musicLibrary.length === 0) return;
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            playLocalTrack(isShuffled ? Math.floor(Math.random() * musicLibrary.length) : (currentIndex > 0 ? currentIndex - 1 : musicLibrary.length - 1));
        }

        function nextTrack() {
            if (currentRadio || musicLibrary.length === 0) return;
            if (isShuffled) {
                let idx; do { idx = Math.floor(Math.random() * musicLibrary.length); } while (idx === currentIndex && musicLibrary.length > 1);
                playLocalTrack(idx);
            } else {
                playLocalTrack((currentIndex + 1) % musicLibrary.length);
            }
        }

        function handleTrackEnd() {
            if (currentRadio) return;
            if (repeatMode === 'one') { audio.currentTime = 0; audio.play(); }
            else if (repeatMode === 'all') nextTrack();
            else if (currentIndex < musicLibrary.length - 1) nextTrack();
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            document.getElementById('shuffleMode').checked = isShuffled;
            updateShuffleBtn();
            saveSettings();
            showToast(isShuffled ? 'üîÄ Aleat√≥rio ativado' : 'üîÄ Aleat√≥rio desativado', 'info');
        }

        function toggleRepeat() {
            const modes = ['none', 'one', 'all'];
            repeatMode = modes[(modes.indexOf(repeatMode) + 1) % 3];
            document.getElementById('repeatOne').checked = repeatMode === 'one';
            document.getElementById('repeatPlaylist').checked = repeatMode === 'all';
            updateRepeatBtn();
            saveSettings();
            const msgs = { none: 'üîÅ Repeti√ß√£o desativada', one: 'üîÇ Repetir m√∫sica', all: 'üîÅ Repetir playlist' };
            showToast(msgs[repeatMode], 'info');
        }

        function updatePlayBtn() {
            document.getElementById('playPauseBtn').querySelector('i').className = isPlaying ? 'fas fa-pause' : 'fas fa-play ml-1';
        }

        function updateShuffleBtn() {
            document.getElementById('shuffleBtn').classList.toggle('text-cyan-400', isShuffled);
        }

        function updateRepeatBtn() {
            const btn = document.getElementById('repeatBtn');
            btn.classList.toggle('text-cyan-400', repeatMode !== 'none');
            btn.querySelector('i').className = repeatMode === 'one' ? 'fas fa-redo-alt' : 'fas fa-redo';
        }

        function updateVolume() {
            const vol = document.getElementById('volumeBar').value;
            audio.volume = vol / 100;
            document.getElementById('volumePercent').textContent = vol + '%';
            const icon = document.getElementById('volumeIcon');
            icon.className = vol == 0 ? 'fas fa-volume-mute' : vol < 50 ? 'fas fa-volume-down' : 'fas fa-volume-up';
            saveSettings();
        }

        function toggleMute() {
            const bar = document.getElementById('volumeBar');
            if (+bar.value > 0) { lastVolume = bar.value; bar.value = 0; }
            else { bar.value = lastVolume || 80; }
            updateVolume();
        }

        function updateNowPlaying(title, subtitle) {
            document.getElementById('currentTitle').textContent = title;
            document.getElementById('currentArtist').textContent = subtitle;
        }

        function showLiveIndicator(show) {
            document.getElementById('liveIndicator').classList.toggle('hidden', !show);
            document.getElementById('liveText').classList.toggle('hidden', !show);
        }

        // =============================================
        // REMOVER / LIMPAR
        // =============================================
        async function removeTrack(index) {
            const music = musicLibrary[index];
            try {
                await deleteMusic(music.id);
                musicLibrary.splice(index, 1);
                if (currentIndex === index && !currentRadio) {
                    audio.pause(); audio.src = '';
                    if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
                    currentIndex = -1; isPlaying = false;
                    updatePlayBtn(); stopVisualizer();
                    updateNowPlaying('Nenhuma m√∫sica', 'Selecione uma m√∫sica');
                } else if (currentIndex > index) currentIndex--;
                renderLibrary();
                showToast('M√∫sica removida', 'info');
            } catch (err) { console.error('Erro:', err); }
        }

        async function clearLibrary() {
            if (musicLibrary.length === 0) { showToast('Biblioteca j√° vazia', 'info'); return; }
            if (!confirm('Remover todas as m√∫sicas?')) return;
            try {
                await clearAllMusic();
                audio.pause(); audio.src = '';
                if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
                musicLibrary = []; currentIndex = -1; isPlaying = false;
                updatePlayBtn(); stopVisualizer();
                updateNowPlaying('Nenhuma m√∫sica', 'Selecione uma m√∫sica');
                renderLibrary();
                showToast('Biblioteca limpa!', 'success');
            } catch (err) { console.error('Erro:', err); }
        }

        // =============================================
        // CONFIGURA√á√ïES
        // =============================================
        function loadSettings() {
            try {
                const cfg = JSON.parse(localStorage.getItem('radiomc_settings') || '{}');
                repeatMode = cfg.repeat || 'all';
                isShuffled = cfg.shuffle || false;
                lastVolume = cfg.volume || 80;
                document.getElementById('repeatOne').checked = repeatMode === 'one';
                document.getElementById('repeatPlaylist').checked = repeatMode === 'all';
                document.getElementById('shuffleMode').checked = isShuffled;
                document.getElementById('volumeBar').value = lastVolume;
                updateShuffleBtn();
                updateRepeatBtn();
            } catch (e) {}
        }

        function saveSettings() {
            localStorage.setItem('radiomc_settings', JSON.stringify({
                repeat: repeatMode,
                shuffle: isShuffled,
                volume: document.getElementById('volumeBar').value
            }));
        }

        // =============================================
        // VISUALIZADOR
        // =============================================
        let vizActive = false;

        function createVisualizer() {
            const container = document.getElementById('visualizer');
            container.innerHTML = '';
            for (let i = 0; i < 40; i++) {
                const bar = document.createElement('div');
                bar.className = 'bg-gradient-to-t from-cyan-500 to-purple-500 rounded-sm transition-all duration-100';
                bar.style.cssText = 'width:5px;height:4px;';
                container.appendChild(bar);
            }
        }

        function startVisualizer() {
            if (vizActive) return;
            vizActive = true;
            const bars = document.querySelectorAll('#visualizer > div');
            function animate() {
                if (!vizActive) return;
                bars.forEach(bar => { bar.style.height = (Math.random() * 32 + 4) + 'px'; });
                setTimeout(() => requestAnimationFrame(animate), 100);
            }
            animate();
        }

        function stopVisualizer() {
            vizActive = false;
            document.querySelectorAll('#visualizer > div').forEach(bar => { bar.style.height = '4px'; });
        }

        // =============================================
        // UTILIT√ÅRIOS
        // =============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(sec) {
            if (!sec || !isFinite(sec)) return '0:00';
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return m + ':' + s.toString().padStart(2, '0');
        }

        function formatSize(bytes) {
            if (!bytes) return '';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        let toastTimeout = null;
        function showToast(msg, type = 'info') {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            if (toastTimeout) clearTimeout(toastTimeout);
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = msg;
            document.body.appendChild(toast);
            toastTimeout = setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        window.onbeforeunload = () => { if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl); };
    </script>
</body>
</html>
